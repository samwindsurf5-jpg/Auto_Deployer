// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  avatarUrl String?  @map("avatar_url")
  githubId  Int?     @unique @map("github_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organizationMembers OrganizationMember[]
  providerIntegrations ProviderIntegration[]
  deployments         Deployment[]
  auditLogs          AuditLog[]

  @@index([email])
  @@index([githubId])
  @@map("users")
}

model Organization {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  plan         String   @default("free")
  billingEmail String?  @map("billing_email")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  members  OrganizationMember[]
  projects Project[]

  @@index([slug])
  @@map("organizations")
}

model OrganizationMember {
  id             String    @id @default(cuid())
  organizationId String    @map("organization_id")
  userId         String    @map("user_id")
  role           String    @default("member")
  invitedAt      DateTime  @default(now()) @map("invited_at")
  joinedAt       DateTime? @map("joined_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@map("organization_members")
}

model Repository {
  id            String   @id @default(cuid())
  githubId      Int      @unique @map("github_id")
  fullName      String   @map("full_name")
  url           String
  defaultBranch String   @default("main") @map("default_branch")
  private       Boolean  @default(false)
  language      String?
  description   String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  projects  Project[]
  analyses  RepositoryAnalysis[]

  @@map("repositories")
}

model RepositoryAnalysis {
  id               String   @id @default(cuid())
  repositoryId     String   @map("repository_id")
  branch           String
  commitSha        String   @map("commit_sha")
  frameworkName    String?  @map("framework_name")
  frameworkVersion String?  @map("framework_version")
  confidenceScore  Float?   @map("confidence_score")
  language         String?
  buildConfig      Json?    @map("build_config")
  dependencies     Json?
  environmentVars  Json?    @map("environment_variables")
  recommendations  Json?
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  repository Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@index([repositoryId])
  @@index([createdAt])
  @@map("repository_analyses")
}

model Project {
  id             String   @id @default(cuid())
  name           String
  slug           String
  description    String?
  organizationId String   @map("organization_id")
  repositoryId   String?  @map("repository_id")
  status         String   @default("active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization       Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  repository         Repository?          @relation(fields: [repositoryId], references: [id])
  deployments        Deployment[]
  environmentVariables EnvironmentVariable[]
  databases          Database[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([status])
  @@map("projects")
}

model EnvironmentVariable {
  id            String   @id @default(cuid())
  projectId     String   @map("project_id")
  environment   String
  key           String
  encryptedValue String  @map("encrypted_value")
  isSecret      Boolean  @default(false) @map("is_secret")
  classification String? 
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, environment, key])
  @@index([projectId, environment])
  @@map("environment_variables")
}

model Deployment {
  id            String    @id @default(cuid())
  projectId     String    @map("project_id")
  branch        String
  commitSha     String    @map("commit_sha")
  status        String    @default("queued")
  provider      String
  environment   String    @default("production")
  url           String?
  previewUrl    String?   @map("preview_url")
  configuration Json?
  metadata      Json?
  logs          Json[]    @default([])
  startedAt     DateTime  @default(now()) @map("started_at")
  completedAt   DateTime? @map("completed_at")
  createdBy     String    @map("created_by")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [createdBy], references: [id])

  @@index([projectId, status])
  @@index([createdBy])
  @@index([startedAt])
  @@map("deployments")
}

model Database {
  id         String   @id @default(cuid())
  projectId  String   @map("project_id")
  provider   String
  name       String
  type       String
  region     String?
  plan       String   @default("free")
  status     String   @default("provisioning")
  connectionString String? @map("connection_string")
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("databases")
}

model ProviderIntegration {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  provider     String
  externalId   String?   @map("external_id")
  encryptedToken Json    @map("encrypted_token")
  refreshToken String?   @map("refresh_token")
  expiresAt    DateTime? @map("expires_at")
  scopes       String[]
  metadata     Json?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@map("provider_integrations")
}

model AuditLog {
  id           String   @id @default(cuid())
  eventId      String   @unique @map("event_id")
  userId       String?  @map("user_id")
  organizationId String? @map("organization_id")
  action       String
  resource     String
  resourceId   String?  @map("resource_id")
  details      Json
  ipAddress    String   @map("ip_address")
  userAgent    String   @map("user_agent")
  success      Boolean
  errorMessage String?  @map("error_message")
  timestamp    DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([organizationId])
  @@index([timestamp])
  @@index([action])
  @@map("audit_logs")
}

